@page "/metrics"
@rendermode RenderMode.InteractiveServer
@using Microsoft.AspNetCore.Components.Web
@using OpenTelemetry.Proto.Metrics.V1
@implements IDisposable
@using static Signals.Telemetry.Repository

@inject Repository repo

<PageTitle>Metrics</PageTitle>

<fieldset>
    <input type="search" placeholder="Search metrics..." @bind="query.Text" @bind:event="oninput" />
    <select id="scope" title="Scope" @bind="query.ScopeName">
        <option value="">Any scope</option>
        @foreach (var scope in repo.GetUniqueScopes())
        {
            <option value="@scope.Name">@scope.Name</option>
        }
    </select>
    <select id="resource" title="Resource" @bind="query.ServiceName">
        <option value="">Any service</option>
        @foreach (var service in repo.GetUniqueServices())
        {
            <option value="@service">@service
            </option>
        }

    </select>
    <input type="datetime-local" title="Start Time" @bind="query.StartTime" />
    <input type="datetime-local" title="End Time" @bind="query.EndTime" />
</fieldset>
<MetricChart Metrics="selectedMetrics" StartTime="query.StartTime" EndTime="query.EndTime" />
<table>
    <thead>
        <tr>
            @if (string.IsNullOrEmpty(query.ServiceName))
            {
                <th>Service</th>
            }
            @if (string.IsNullOrEmpty(query.ScopeName))
            {
                <th>Scope</th>
            }
            <th>Name</th>
            <th>Description</th>
            <th>Type</th>
            <th>Samples</th>
        </tr>
    </thead>
    <tbody>
        @{
            var metrics = repo.QueryMetrics(query);
            if (!metrics.Any())
            {
                <tr>
                    <td colspan="6" style="text-align: center; font-style: italic;">No metrics found</td>
                </tr>
            }
            @foreach (var metric in metrics)
            {
                <tr @onclick="() => SelectMetric(metric)" style="cursor: pointer;" class="@(selectedMetrics.Contains(metric) ? "active" : "")">
                    @if (string.IsNullOrEmpty(query.ServiceName))
                    {
                        <td>@metric.ServiceName</td>
                    }
                    @if (string.IsNullOrEmpty(query.ScopeName))
                    {
                        <td>@metric.Scope.Name</td>
                    }
                    <td>@metric.Name</td>
                    <td>@metric.Description</td>
                    <td>@metric.DataCase</td>
                    <td>@metric.Samples</td>
                </tr>
            }
        }
    </tbody>
</table>

@code {

    [Inject]
    private Query query { get; set; } = null!;

    private IEnumerable<Metric> selectedMetrics = [];

    private void SelectMetric(Metric metric)
    {
        if (selectedMetrics.Contains(metric))
        {
            selectedMetrics = selectedMetrics.Where(m => m.Name != metric.Name);
        }
        else
        {
            selectedMetrics = selectedMetrics.Append(metric);
        }
    }

    protected override void OnInitialized()
    {
        query.OnChange += StateHasChanged;
    }

    public void Dispose()
    {
        query.OnChange -= StateHasChanged;
    }

}